<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree View</title>
    <style>
        ul {
            list-style-type: none;
            padding-left: 20px;
        }

        li {
            margin-bottom: 5px;
            cursor: pointer;
        }

        #create-form,
        #edit-form {
            margin-top: 20px;
        }
    </style>
</head>
<body>

{% macro render_tree(node) %}
    <ul>
        <li data-key-id="{{ node.key_id }}" onclick="toggleNode(event, this)">
            {{ node.key_name }}
            <button onclick="editNode(event, {{ node.key_id }}, {{ node.parent_key_id }})">Edit</button>
            <button onclick="deleteNode(event, {{ node.key_id }})">Delete</button>
            <button onclick="createChild(event, {{ node.key_id }})">Create Child</button>
            {% if node.children %}
                <ul style="display:none;">
                    {% for child in node.children %}
                        {{ render_tree(child) }}
                    {% endfor %}
                </ul>
            {% endif %}
        </li>
    </ul>
{% endmacro %}

{% for root_key in keys %}
    {{ render_tree(root_key) }}
{% endfor %}

<script>
    function toggleNode(event, node) {
        var childUl = node.querySelector('ul');
        var keyId = node.getAttribute('data-key-id');
        //var parentKeyId = node.parentNode.parentNode.getAttribute('data-key-id'); // Adaugă această linie pentru a obține ID-ul nodului părinte


        if (childUl) {
            childUl.style.display = (childUl.style.display === 'none') ? 'block' : 'none';
            getValues(keyId);
            event.stopPropagation();
        } else {
            getValues(keyId);
            event.stopPropagation();
        }
    }

    function getValues(keyId) {
        // Folosește AJAX pentru a obține valorile asociate unui nod
        fetch('/get_values/' + keyId)
            .then(response => response.json())
            .then(data => displayValues(keyId, data));
    }

    function displayValues(keyId, values) {
        var valuesContainer = document.getElementById('values-container');
        valuesContainer.innerHTML = ''; // Curăță conținutul anterior

        // Setează atributul data-key-id pentru values-container
        valuesContainer.setAttribute('data-key-id', keyId);

        values.forEach(function(value) {
            var valueDiv = document.createElement('div');
            // Adaugă atributul de date pentru valueId (nu va fi vizibil în pagină)
            valueDiv.dataset.valueId = value.valueId;

            // Adaugă id-ul într-un atribut invizibil pentru a fi folosit în funcțiile delete și edit
            valueDiv.innerHTML = '<strong>Name:</strong> ' + value.name + '<br>' +
                                 '<strong>Type:</strong> ' + value.type + '<br>' +
                                 '<strong>Data:</strong> ' + value.data + '<br>';
            // Adăugăm butoanele de edit și delete în containerul de valori
            valueDiv.innerHTML += '<button onclick="editValue(' + value.valueId + ', \'' + value.name + '\', \'' + value.type + '\', \'' + value.data + '\')">Edit</button>';
            valueDiv.innerHTML += '<button onclick="deleteValue(' + value.valueId + ')">Delete</button>';
            valueDiv.innerHTML += '<br><br>';
            valuesContainer.appendChild(valueDiv);
        });

        // Afișează formularul de creare a noii valori
        document.getElementById('create-form').style.display = 'block';
        // Ascunde formularul de editare
        document.getElementById('edit-form').style.display = 'none';
    }




    // Funcționalitate pentru editarea unui nod din arbore
    function editNode(event, keyId, parentKeyId) {
        event.stopPropagation();
        var nodeName = prompt('Enter the new name for the node:');
        if (nodeName !== null) {
            // Trimite datele actualizate la server, inclusiv ID-ul nodului părinte
            fetch('/update_node/' + keyId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: nodeName, parent_key_id: parentKeyId }),
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                // Reafișează arborele după actualizarea numelui
                location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    }


    // Funcționalitate pentru ștergerea unui nod din arbore
    function deleteNode(event, keyId) {
        event.stopPropagation();
        var confirmDelete = confirm('Are you sure you want to delete this node and its children?');
        if (confirmDelete) {
            // Trimite cererea de ștergere la server
            fetch('/delete_node/' + keyId, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                // Reafișează arborele după ștergerea nodului
                location.reload();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    }

    function editValue(valueId, name, type, data) {
        // Afiseaza formularul de editare a valorii
        document.getElementById('edit-form').style.display = 'block';

        // Completeaza campurile din formular cu datele valorii existente
        document.getElementById('edit-value-id').value = valueId;
        document.getElementById('edit-value-name').value = name;
        document.getElementById('edit-value-type').value = type;
        document.getElementById('edit-value-data').value = data;

        // Adauga event listener pentru formularul de editare
        document.getElementById('edit-value-form').onsubmit = function (event) {
            event.preventDefault();
            var id = document.getElementById('edit-value-id').value;
            var newName = document.getElementById('edit-value-name').value;
            var newType = document.getElementById('edit-value-type').value;
            var newData = document.getElementById('edit-value-data').value;

            // Trimite datele actualizate la server
            fetch('/update_value/' + id, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: newName, type: newType, data: newData }),
            })
                .then(response => response.json())
                .then(result => {
                    alert(result.message);
                    // Reafișează valorile după actualizarea valorii
                    getValues(result.keyId);
                    // Ascunde formularul de editare
                    document.getElementById('edit-form').style.display = 'none';
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        };
    }

    // Funcționalitate pentru ștergerea unei valori
    function deleteValue(valueId) {
        var confirmDelete = confirm('Are you sure you want to delete this value?');
        if (confirmDelete) {
            // Trimite cererea de ștergere la server
            fetch('/delete_value/' + valueId, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(result => {
                alert(result.message);
                // Elimină valoarea din pagina web după ștergerea acesteia
                document.querySelector(`[data-value-id="${valueId}"]`).remove();
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }
    }


    // Funcționalitate pentru crearea unei valori noi
    function createValue() {
        var keyId = document.getElementById('values-container').getAttribute('data-key-id');
        var newName = document.getElementById('new-value-name').value;
        var newType = document.getElementById('new-value-type').value;
        var newData = document.getElementById('new-value-data').value;

        // Trimite datele pentru crearea valorii la server
        fetch('/create_value/' + keyId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: newName, type: newType, data: newData }),
        })
        .then(response => response.json())
        .then(result => {
            alert(result.message);
            // Reafișează valorile după adăugarea noii valori
            getValues(keyId);
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }


    // Funcționalitate pentru adăugarea unui copil pentru un nod din arbore
    function createChild(event, keyId) {
    event.stopPropagation();
    var childName = prompt('Enter the name for the new child node:');
    if (childName !== null) {
        // Trimite datele pentru crearea unui nou copil la server
        fetch('/create_key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name: childName, parent_key_id: keyId }),
        })
        .then(response => response.json())
        .then(result => {
            alert(result.message);
            // Reafișează arborele după adăugarea noului copil
            location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    }
}

    function searchRegistry() {
        var searchInput = document.getElementById('search-input').value.toLowerCase();
        var treeNodes = document.querySelectorAll('[data-key-id]');
        var valuesContainer = document.getElementById('values-container');

        treeNodes.forEach(function(node) {
            var nodeName = node.textContent.toLowerCase();
            var displayStyle = nodeName.includes(searchInput) ? 'block' : 'none';
            node.style.display = displayStyle;
        });

        // Afisează sau ascunde lista de valori în funcție de rezultatul căutării
        var displayValues = searchInput === '' ? 'none' : 'block';
        valuesContainer.style.display = displayValues;

        // Dacă căutarea este goală, reafișează toate nodurile
        if (searchInput === '') {
            treeNodes.forEach(function(node) {
                node.style.display = 'block';
            });
        }
    }

    function searchValues() {
        var searchValuesInput = document.getElementById('search-values-input').value.toLowerCase();
        var valuesContainer = document.getElementById('values-container');

        // Verifică dacă bara de căutare a valorilor este goală
        if (searchValuesInput.trim() === '') {
            // Dacă este goală, curăță containerul de valori și ascunde formularul de editare
            valuesContainer.innerHTML = '';
            document.getElementById('edit-form').style.display = 'none';
            return;
        }

        // Dacă nu este goală, folosește AJAX pentru a obține toate valorile
        fetch('/get_all_values')
            .then(response => response.json())
            .then(data => {
                var values = data.filter(value => value.name.toLowerCase().includes(searchValuesInput));
                displayValues(valuesContainer.getAttribute('data-key-id'), values);
            });
    }

</script>

<div style="margin-top: 20px;">
    <label for="search-input">Search Registry:</label>
    <input type="text" id="search-input" oninput="searchRegistry()">
</div>

<div>
    <!-- Bara de căutare pentru valori -->
    <label for="search-values-input">Search Values:</label>
    <input type="text" id="search-values-input" oninput="searchValues()">
</div>

<!-- Partea dreaptă: Valorile asociate nodului selectat și formularul pentru crearea și editarea valorilor -->
<div style="float: left; width: 70%;">
    <div id="values-container">
        <!-- Valorile vor fi afișate aici -->
    </div>
    <div id="create-form">
        Create new value:
        <label for="new-value-name">Name:</label>
        <input type="text" id="new-value-name">

        <label for="new-value-type">Type:</label>
        <select id="new-value-type">
            <!-- Adăugați opțiunile aici, folosind o buclă sau manual -->
            <option value="REG_BINARY">REG_BINARY</option>
            <option value="REG_DWORD">REG_DWORD</option>
            <option value="REG_QWORD">REG_QWORD</option>
            <option value="REG_EXPAND_SZ">REG_EXPAND_SZ</option>
            <option value="REG_MULTI_SZ">REG_MULTI_SZ</option>
            <option value="REG_SZ">REG_SZ</option>
            <!-- Adăugați altele după nevoie -->
        </select>

        <label for="new-value-data">Data:</label>
        <input type="text" id="new-value-data">

        <button onclick="createValue()">Submit</button>
    </div>
    <div id="edit-form">
        Edit value:
        <form id="edit-value-form">
            <input type="hidden" id="edit-value-id">

            <label for="edit-value-name">Name:</label>
            <input type="text" id="edit-value-name">

            <label for="edit-value-type">Type:</label>
            <select id="edit-value-type">
                <!-- Adăugați opțiunile aici, folosind o buclă sau manual -->
                <option value="REG_BINARY">REG_BINARY</option>
                <option value="REG_DWORD">REG_DWORD</option>
                <option value="REG_QWORD">REG_QWORD</option>
                <option value="REG_EXPAND_SZ">REG_EXPAND_SZ</option>
                <option value="REG_MULTI_SZ">REG_MULTI_SZ</option>
                <option value="REG_SZ">REG_SZ</option>
                <!-- Adăugați altele după nevoie -->
            </select>

            <label for="edit-value-data">Data:</label>
            <input type="text" id="edit-value-data">

            <button onclick="">Submit</button>
        </form>
    </div>
</div>

</body>
</html>
